<nav class="navbar">
  <div class="navbar-container">
    <!-- Logo -->
    <div class="navbar-brand">
      <a routerLink="/product-list" class="logo">
        <img src="logo-marchify.png" alt="Marchify Logo" class="logo-img" />
        <span class="brand-name">Marchify</span>
      </a>
    </div>

    <!-- Desktop Navigation -->
    <div class="navbar-menu" [class.active]="isMobileMenuOpen">
      <ul class="nav-items">
        <li *ngFor="let item of navItems" class="nav-item">
          <!-- Regular link (no children) -->
          <a
            *ngIf="!item.children"
            [routerLink]="item.path"
            routerLinkActive="active"
            class="nav-link"
            (click)="closeMobileMenu()">
            <i [class]="item.icon"></i>
            <span>{{ item.label }}</span>
          </a>

          <!-- Dropdown link (has children) -->
          <div *ngIf="item.children" class="dropdown">
            <button
              class="nav-link dropdown-toggle"
              [class.active]="activeDropdown === item.label"
              (click)="toggleDropdown(item.label)">
              <i [class]="item.icon"></i>
              <span>{{ item.label }}</span>
              <i class="fas fa-chevron-down chevron"></i>
            </button>

            <ul class="dropdown-menu" [class.show]="activeDropdown === item.label">
              <li *ngFor="let child of item.children">
                <a
                  [routerLink]="child.path"
                  routerLinkActive="active"
                  class="dropdown-item"
                  (click)="closeMobileMenu()">
                  <i [class]="child.icon"></i>
                  <span>{{ child.label }}</span>
                </a>
              </li>
            </ul>
          </div>
        </li>
      </ul>
    </div>

    <!-- Right side actions -->
    <div class="navbar-actions">
      <!-- Notification button -->
      <button class="icon-btn notification-btn" (click)="navigateToNotifications()">
        <i class="fas fa-bell"></i>
        @if (unreadCount > 0) {
          <span class="badge">{{ unreadCount }}</span>
        }
      </button>

      <!-- Cart button -->
      <button class="icon-btn cart-btn" (click)="navigateToCart()">
        <i class="fas fa-shopping-cart"></i>
        <span class="badge" *ngIf="(cartCount$ | async) as count">
          {{ count }}
        </span>
      </button>

      <!-- ðŸ”¹ User Dropdown Menu -->
      <ng-container *ngIf="authState$ | async as auth">
        <ng-container *ngIf="auth.isLogged; else notLogged">
          <!-- User Dropdown -->
          <div class="user-dropdown-container">
            <button 
              class="user-dropdown-btn"
              (click)="toggleUserDropdown()">
              <i class="fas fa-user-circle"></i>
              <span class="username">
                {{ auth.user?.prenom || auth.user?.nom || 'Utilisateur' }}
              </span>
              <i class="fas fa-chevron-down chevron-icon" [class.rotate]="isUserDropdownOpen"></i>
            </button>

            <!-- Dropdown Menu -->
            <div class="user-dropdown-menu" [class.show]="isUserDropdownOpen">
              <!-- User Info Header -->
              <div class="dropdown-header">
                <div class="user-avatar">
                  <i class="fas fa-user-circle"></i>
                </div>
                <div class="user-details">
                  <p class="user-name">{{ auth.user?.prenom || auth.user?.nom }}</p>
                  <p class="user-email">{{ auth.user?.email }}</p>
                  <span class="role-badge">{{ auth.role }}</span>
                </div>
              </div>

              <div class="dropdown-divider"></div>

              <!-- Role-specific Menu Items -->
              <div class="dropdown-items">
                <a 
                  *ngFor="let item of getFilteredDropdownItems(auth.role)"
                  [routerLink]="item.path"
                  class="dropdown-item"
                  (click)="closeUserDropdown(); closeMobileMenu()">
                  <i [class]="item.icon"></i>
                  <span>{{ item.label }}</span>
                </a>
              </div>

              <div class="dropdown-divider"></div>

              <!-- Common Actions -->
              <div class="dropdown-items">
                <a 
                  routerLink="/notifications"
                  class="dropdown-item"
                  (click)="closeUserDropdown(); closeMobileMenu()">
                  <i class="fas fa-bell"></i>
                  <span>Notifications</span>
                </a>
                <button 
                  class="dropdown-item logout-btn"
                  (click)="logout()">
                  <i class="fas fa-sign-out-alt"></i>
                  <span>DÃ©connexion</span>
                </button>
              </div>
            </div>
          </div>
        </ng-container>

        <ng-template #notLogged>
          <!-- Not logged in -->
          <button class="btn-signin ripple-btn" (click)="navigateToLogin()">
            <i class="fas fa-sign-in-alt"></i>
          </button>
          <button class="btn-signup ripple-btn" (click)="navigateToRegister()">
            <i class="fas fa-user-plus"></i>
          </button>
        </ng-template>
      </ng-container>

      <!-- Mobile menu toggle -->
      <button class="mobile-toggle" (click)="toggleMobileMenu()">
        <i
          class="fas"
          [class.fa-bars]="!isMobileMenuOpen"
          [class.fa-times]="isMobileMenuOpen"></i>
      </button>
    </div>
  </div>

  <!-- Mobile backdrop -->
  <div
    class="mobile-backdrop"
    [class.show]="isMobileMenuOpen"
    (click)="closeMobileMenu()"></div>
</nav>

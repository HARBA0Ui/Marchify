generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CLIENT
  VENDEUR
  LIVREUR
  ADMIN
}

enum CmdStatus {
  PENDING
  PROCESSING
  READY
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum UniteMesure {
  GRAMME
  KILOGRAMME
  LITRE
  MILLILITRE
  PIECE
  BOITE
  SAC
  CARTON
  METRE
  CENTIMETRE
  AUTRE
}

enum DeliveryStatus {
  PENDING_PICKUP
  IN_TRANSIT
  DELIVERED
  FAILED
}

enum ReviewType {
  PRODUIT
  BOUTIQUE
}

// NEW: Notification Types
enum NotificationType {
  ORDER_PLACED // Client placed an order
  NEW_ORDER_RECEIVED
  ORDER_CONFIRMED // Vendeur confirmed order
  ORDER_PROCESSING // Order is being prepared
  ORDER_READY // Order ready for pickup
  ORDER_SHIPPED // Order shipped/out for delivery
  ORDER_DELIVERED // Order delivered successfully
  ORDER_CANCELLED // Order was cancelled
  ORDER_RETURNED // Order was returned
  REVIEW_RECEIVED // New review on product/boutique
  PRODUCT_LOW_STOCK // Product stock is low (for vendeurs)
  PRODUCT_OUT_OF_STOCK // Product is out of stock
  NEW_PRODUCT_ADDED // New product in favorite boutique
  DELIVERY_ASSIGNED // Delivery assigned to livreur
  DELIVERY_PICKED_UP // Livreur picked up the order
  DELIVERY_FAILED // Delivery attempt failed
  PROMO_ALERT // Special promotion/discount
  SYSTEM_ANNOUNCEMENT // General system message
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model User {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  nom           String
  prenom        String
  email         String         @unique
  PWD           String
  role          UserRole
  telephone     String
  adresse       Json
  localisation  Json?
  vendeur       Vendeur?
  livreur       Livreur?
  commandes     Commande[]
  Panier        Panier?
  reviews       Review[]
  notifications Notification[] // NEW

  @@map("users")
}

model Vendeur {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String     @unique @db.ObjectId
  boutiques Boutique[]

  @@map("vendeurs")
}

model Boutique {
  id              String            @id @default(auto()) @map("_id") @db.ObjectId
  nom             String
  adresse         String
  localisation    Json?
  categorie       String
  telephone       String
  vendeur         Vendeur           @relation(fields: [vendeurId], references: [id], onDelete: Cascade)
  vendeurId       String            @db.ObjectId
  produits        Produit[]
  commandes       Commande[]
  CommandeProduit CommandeProduit[]
  reviews         Review[]

  @@map("boutiques")
}

model BonDeLivraison {
  id           String         @id @default(auto()) @map("_id") @db.ObjectId
  dateCreation DateTime       @default(now())
  commande     Commande       @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  commandeId   String         @unique @db.ObjectId
  status       DeliveryStatus @default(PENDING_PICKUP)
  livreur      Livreur?       @relation(fields: [livreurId], references: [id], onDelete: Cascade)
  livreurId    String?        @db.ObjectId

  @@map("bon_de_livraison")
}

model Commande {
  id               String            @id @default(auto()) @map("_id") @db.ObjectId
  status           CmdStatus         @default(PENDING)
  adresseLivraison Json
  totalCommande    Float
  dateCommande     DateTime          @default(now())
  client           User              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId         String            @db.ObjectId
  boutique         Boutique?         @relation(fields: [boutiqueId], references: [id], onDelete: Cascade)
  boutiqueId       String?           @db.ObjectId
  produits         CommandeProduit[]
  bonDeLivraison   BonDeLivraison?
  notifications    Notification[] // NEW: Track notifications for this order

  @@map("commandes")
}

model Livreur {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  localisation   Json?
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String           @unique @db.ObjectId
  BonDeLivraison BonDeLivraison[]

  @@map("livreurs")
}

model Produit {
  id                 String            @id @default(auto()) @map("_id") @db.ObjectId
  nom                String
  prix               Float
  categorie          String
  description        String
  image              String
  quantite           Int
  unite              UniteMesure       @default(KILOGRAMME)
  unitePersonnalisee String?
  livrable           Boolean           @default(true)
  Ispinned           Boolean           @default(false)
  boutique           Boutique?         @relation(fields: [boutiqueId], references: [id], onDelete: Cascade)
  boutiqueId         String?           @db.ObjectId
  commandes          CommandeProduit[]
  PanierProduit      PanierProduit[]
  reviews            Review[]

  @@map("produits")
}

model CommandeProduit {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  quantite   Int      @default(1)
  prixTotal  Float
  dateAjout  DateTime @default(now())
  dateModif  DateTime @updatedAt
  commande   Commande @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  commandeId String   @db.ObjectId
  produit    Produit  @relation(fields: [produitId], references: [id], onDelete: Cascade)
  produitId  String   @db.ObjectId
  boutique   Boutique @relation(fields: [boutiqueId], references: [id])
  boutiqueId String   @db.ObjectId

  @@map("commande_produits")
}

model Panier {
  id       String          @id @default(auto()) @map("_id") @db.ObjectId
  client   User            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String          @unique @db.ObjectId
  produits PanierProduit[]
  total    Float           @default(0)
  dateMaj  DateTime        @updatedAt

  @@map("paniers")
}

model PanierProduit {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  quantite  Int      @default(1)
  prixTotal Float
  dateAjout DateTime @default(now())
  dateMaj   DateTime @updatedAt
  panier    Panier   @relation(fields: [panierId], references: [id], onDelete: Cascade)
  panierId  String   @db.ObjectId
  produit   Produit  @relation(fields: [produitId], references: [id], onDelete: Cascade)
  produitId String   @db.ObjectId

  @@unique([panierId, produitId])
  @@map("panier_produits")
}

model Review {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  type       ReviewType
  rating     Int
  comment    String?
  createdAt  DateTime   @default(now())
  auteur     User       @relation(fields: [auteurId], references: [id], onDelete: Cascade)
  auteurId   String     @db.ObjectId
  produit    Produit?   @relation(fields: [produitId], references: [id])
  produitId  String?    @db.ObjectId
  boutique   Boutique?  @relation(fields: [boutiqueId], references: [id])
  boutiqueId String?    @db.ObjectId

  @@map("reviews")
}

// NEW: Notification Model
model Notification {
  id        String               @id @default(auto()) @map("_id") @db.ObjectId
  type      NotificationType
  priority  NotificationPriority @default(MEDIUM)
  title     String
  message   String
  read      Boolean              @default(false)
  createdAt DateTime             @default(now())
  readAt    DateTime?

  // Recipient
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @db.ObjectId

  // Optional: Related entities
  commande   Commande? @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  commandeId String?   @db.ObjectId

  // Optional: Action data (stored as JSON for flexibility)
  actionUrl String? // URL to navigate to when clicked
  metadata  Json? // Extra data (product info, delivery details, etc.)

  @@index([userId, read]) // Index for efficient queries
  @@index([createdAt])
  @@map("notifications")
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CLIENT
  VENDEUR
  LIVREUR
  ADMIN
}

enum CmdStatus {
  PENDING
  PROCESSING
  READY
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum UniteMesure {
  GRAMME
  KILOGRAMME
  LITRE
  MILLILITRE
  PIECE
  BOITE
  SAC
  CARTON
  METRE
  CENTIMETRE
  AUTRE
}

enum DeliveryStatus {
  PENDING_PICKUP
  IN_TRANSIT
  DELIVERED
  FAILED
}

model User {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  nom          String
  prenom       String
  email        String   @unique
  PWD          String
  role         UserRole
  telephone    String
  adresse      Json
  localisation Json?
  vendeur   Vendeur?
  livreur   Livreur?
  commandes Commande[]
  Panier    Panier?
  reviews Review[]
  @@map("users")
}

model Vendeur {
  id     String @id @default(auto()) @map("_id") @db.ObjectId
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique @db.ObjectId
  boutiques Boutique[]
  @@map("vendeurs")
}

model Boutique {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  nom          String
  adresse      String
  localisation Json?
  categorie    String
  telephone    String
  vendeur         Vendeur           @relation(fields: [vendeurId], references: [id], onDelete: Cascade)
  vendeurId       String            @db.ObjectId
  produits        Produit[]
  commandes       Commande[]
  CommandeProduit CommandeProduit[]
  reviews Review[]
  @@map("boutiques")
}

model BonDeLivraison {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  dateCreation DateTime @default(now())
  commande   Commande @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  commandeId String   @unique @db.ObjectId
  status DeliveryStatus @default(PENDING_PICKUP)
  livreur   Livreur @relation(fields: [livreurId], references: [id], onDelete: Cascade)
  livreurId String  @db.ObjectId
  @@map("bon_de_livraison")
}

model Commande {
  id               String    @id @default(auto()) @map("_id") @db.ObjectId
  status           CmdStatus @default(PENDING)
  adresseLivraison Json
  totalCommande    Float
  dateCommande     DateTime  @default(now())
  client     User              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId   String            @db.ObjectId
  boutique   Boutique?         @relation(fields: [boutiqueId], references: [id], onDelete: Cascade)
  boutiqueId String?           @db.ObjectId
  produits   CommandeProduit[]
  bonDeLivraison BonDeLivraison?
  @@map("commandes")
}

model Livreur {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  localisation   Json?
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String           @unique @db.ObjectId
  BonDeLivraison BonDeLivraison[]
  @@map("livreurs")
}

model Produit {
  id                 String      @id @default(auto()) @map("_id") @db.ObjectId
  nom                String
  prix               Float
  categorie          String
  description        String
  image              String
  quantite           Int
  unite              UniteMesure @default(KILOGRAMME)
  unitePersonnalisee String?
  livrable           Boolean     @default(true)
  boutique      Boutique?         @relation(fields: [boutiqueId], references: [id], onDelete: Cascade)
  boutiqueId    String?           @db.ObjectId
  commandes     CommandeProduit[]
  PanierProduit PanierProduit[]
  reviews Review[]
  @@map("produits")
}

model CommandeProduit {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  quantite  Int      @default(1)
  prixTotal Float
  dateAjout DateTime @default(now())
  dateModif DateTime @updatedAt
  commande   Commande @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  commandeId String   @db.ObjectId
  produit    Produit  @relation(fields: [produitId], references: [id], onDelete: Cascade)
  produitId  String   @db.ObjectId
  boutique   Boutique @relation(fields: [boutiqueId], references: [id])
  boutiqueId String   @db.ObjectId
  @@map("commande_produits")
}

model Panier {
  id       String          @id @default(auto()) @map("_id") @db.ObjectId
  client   User            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId String          @unique @db.ObjectId
  produits PanierProduit[]
  total    Float           @default(0)
  dateMaj  DateTime        @updatedAt
  @@map("paniers")
}

model PanierProduit {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  quantite  Int      @default(1)
  prixTotal Float
  dateAjout DateTime @default(now())
  dateMaj   DateTime @updatedAt
  panier    Panier  @relation(fields: [panierId], references: [id], onDelete: Cascade)
  panierId  String  @db.ObjectId
  produit   Produit @relation(fields: [produitId], references: [id], onDelete: Cascade)
  produitId String  @db.ObjectId
  @@unique([panierId, produitId])
  @@map("panier_produits")
}
enum ReviewType {
  PRODUIT
  BOUTIQUE
}

model Review {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  type      ReviewType
  rating    Int        
  comment   String?
  createdAt DateTime   @default(now())
  auteur     User      @relation(fields: [auteurId], references: [id], onDelete: Cascade)
  auteurId   String    @db.ObjectId
  produit    Produit?  @relation(fields: [produitId], references: [id])
  produitId  String?   @db.ObjectId
  boutique   Boutique? @relation(fields: [boutiqueId], references: [id])
  boutiqueId String?   @db.ObjectId
  @@map("reviews")
}